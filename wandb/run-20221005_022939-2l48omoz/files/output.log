current path: saved_models/model_mnist_Oct.05_02.29.37
Loading data
build_classes_dict done
train loaders done
get poison test loader
Starting performing KrMLRFL...
load data done
Loaded parameters from saved model: LR is 0.1 and current epoch is 11
create model done
Poisoned following participants: [41, 73, 51, 74]
We use following environment for graphs:  mnist_DBA
Server Epoch:11 choose agents : [23, 72, 61, 11, 71, 42, 45, 37, 21, 35].
___Train Local_Simple,  epoch  11, local model 23, internal_epoch   1,  Average loss: 0.0008, Accuracy: 289/293 (98.6348%)
___Train Local_Simple,  epoch  11, local model 23, internal_epoch   2,  Average loss: 0.0004, Accuracy: 292/293 (99.6587%)
___Test Local_Simple poisoned: False, epoch: 11: Average loss: 0.1097, Accuracy: 9646/10000 (96.4600%)
___Train Local_Simple,  epoch  11, local model 72, internal_epoch   1,  Average loss: 0.0007, Accuracy: 719/731 (98.3584%)
___Train Local_Simple,  epoch  11, local model 72, internal_epoch   2,  Average loss: 0.0001, Accuracy: 730/731 (99.8632%)
___Test Local_Simple poisoned: False, epoch: 11: Average loss: 0.2988, Accuracy: 8998/10000 (89.9800%)
poison local model 61 index 0
class_loss: 3.5104146003723145, distance_loss: 0.0
class_loss: 1.8648605346679688, distance_loss: 0.3162311911582947
class_loss: 1.1312787532806396, distance_loss: 0.7744445204734802
class_loss: 1.1551026105880737, distance_loss: 1.1992974281311035
class_loss: 1.1223413944244385, distance_loss: 1.5319246053695679
class_loss: 1.1552973985671997, distance_loss: 1.8200098276138306
class_loss: 0.9727140665054321, distance_loss: 2.0811071395874023
class_loss: 0.9655166864395142, distance_loss: 2.3258538246154785
class_loss: 0.9581470489501953, distance_loss: 2.5514469146728516
___PoisonTrain Local_Simple ,  epoch  11, local model 61, internal_epoch   1,  Average loss: 0.0211, Accuracy: 427/699 (61.0873%), train_poison_data_count: 220
class_loss: 0.8991203904151917, distance_loss: 2.761491060256958
class_loss: 0.9833215475082397, distance_loss: 2.9537038803100586
class_loss: 0.7647413611412048, distance_loss: 3.1338162422180176
class_loss: 0.822985827922821, distance_loss: 3.299034357070923
class_loss: 0.8584273457527161, distance_loss: 3.4473769664764404
class_loss: 0.6633390188217163, distance_loss: 3.5703072547912598
class_loss: 0.7161194086074829, distance_loss: 3.684647560119629
class_loss: 0.6452226638793945, distance_loss: 3.7905874252319336
class_loss: 0.8104360699653625, distance_loss: 3.8859505653381348
class_loss: 0.8298172354698181, distance_loss: 3.972400665283203
class_loss: 0.6129510998725891, distance_loss: 4.05469274520874
class_loss: 0.732403576374054, distance_loss: 4.1317219734191895
class_loss: 0.6955287456512451, distance_loss: 4.202526092529297
___PoisonTrain Local_Simple ,  epoch  11, local model 61, internal_epoch   2,  Average loss: 0.0117, Accuracy: 456/699 (65.2361%), train_poison_data_count: 220
Global model norm: 16.539532092117113.
Norm before scaling: 16.71508246864471. Distance: 4.268344333748208
Total norm for 5 adversaries is: 16.71508246864471. distance: 4.268344333748208
___Test Local_Simple poisoned: True, epoch: 11: Average loss: 0.9907, Accuracy: 4928/8968 (54.9509%)
class_loss: 4.539518356323242, distance_loss: 0.0
class_loss: 2.417982816696167, distance_loss: 0.3524917960166931
class_loss: 1.4732260704040527, distance_loss: 0.8848463296890259
poison local model 11 index 1
class_loss: 1.7820674180984497, distance_loss: 1.4030033349990845
class_loss: 1.670753002166748, distance_loss: 1.8188773393630981
class_loss: 1.6887736320495605, distance_loss: 2.178250312805176
class_loss: 1.69856858253479, distance_loss: 2.496901273727417
class_loss: 1.6251591444015503, distance_loss: 2.78171706199646
class_loss: 1.5262686014175415, distance_loss: 3.03717303276062
class_loss: 1.4118624925613403, distance_loss: 3.267648220062256
class_loss: 0.958504855632782, distance_loss: 3.4760050773620605
class_loss: 1.4650713205337524, distance_loss: 3.691863536834717
class_loss: 1.410029649734497, distance_loss: 3.872204542160034
class_loss: 1.0932815074920654, distance_loss: 4.0163750648498535
class_loss: 0.9721927642822266, distance_loss: 4.147823810577393
class_loss: 1.0221666097640991, distance_loss: 4.27739143371582
class_loss: 1.0412579774856567, distance_loss: 4.401827812194824
class_loss: 1.0627564191818237, distance_loss: 4.519493103027344
class_loss: 1.1959556341171265, distance_loss: 4.631038188934326
class_loss: 1.1005122661590576, distance_loss: 4.736700057983398
class_loss: 0.9711346626281738, distance_loss: 4.836575508117676
class_loss: 1.1528176069259644, distance_loss: 4.929904937744141
___PoisonTrain Local_Simple ,  epoch  11, local model 11, internal_epoch   1,  Average loss: 0.0322, Accuracy: 278/645 (43.1008%), train_poison_data_count: 205
___PoisonTrain Local_Simple ,  epoch  11, local model 11, internal_epoch   2,  Average loss: 0.0194, Accuracy: 327/645 (50.6977%), train_poison_data_count: 205
Global model norm: 16.539532092117113.
Norm before scaling: 16.817764082086036. Distance: 5.039996771735717
Total norm for 5 adversaries is: 16.817764082086036. distance: 5.039996771735717
___Test Local_Simple poisoned: True, epoch: 11: Average loss: 0.5739, Accuracy: 6676/8968 (74.4425%)
class_loss: 3.6337695121765137, distance_loss: 0.0
class_loss: 1.7928739786148071, distance_loss: 0.41091495752334595
class_loss: 1.7432215213775635, distance_loss: 0.9174676537513733
class_loss: 1.9602717161178589, distance_loss: 1.3058750629425049
class_loss: 1.6159952878952026, distance_loss: 1.6268266439437866
class_loss: 1.4152852296829224, distance_loss: 1.9485597610473633
class_loss: 1.252673864364624, distance_loss: 2.2607614994049072
class_loss: 1.1137242317199707, distance_loss: 2.5523931980133057
class_loss: 1.0592970848083496, distance_loss: 2.824855089187622
class_loss: 0.9669270515441895, distance_loss: 3.0798180103302
class_loss: 1.0418484210968018, distance_loss: 3.315126419067383
class_loss: 0.8774325251579285, distance_loss: 3.5317788124084473
class_loss: 0.9572365880012512, distance_loss: 3.7297279834747314
class_loss: 0.7480521202087402, distance_loss: 3.912001371383667
class_loss: 1.210070252418518, distance_loss: 4.08030366897583
class_loss: 0.8688193559646606, distance_loss: 4.226978778839111
class_loss: 0.8538863062858582, distance_loss: 4.355586051940918
class_loss: 0.7134546041488647, distance_loss: 4.472978591918945
class_loss: 0.7847453355789185, distance_loss: 4.581131458282471
class_loss: 0.9073823094367981, distance_loss: 4.6792426109313965
class_loss: 0.839368462562561, distance_loss: 4.768661975860596
class_loss: 0.9180275797843933, distance_loss: 4.852058410644531
poison local model 71 index 2
___PoisonTrain Local_Simple ,  epoch  11, local model 71, internal_epoch   1,  Average loss: 0.0197, Accuracy: 772/1384 (55.7803%), train_poison_data_count: 440
class_loss: 0.7988826632499695, distance_loss: 4.930307865142822
class_loss: 0.8729764819145203, distance_loss: 5.001896858215332
class_loss: 0.7474075555801392, distance_loss: 5.067049503326416
class_loss: 0.8452214598655701, distance_loss: 5.126030921936035
class_loss: 0.8826793432235718, distance_loss: 5.176770210266113
class_loss: 0.8133206963539124, distance_loss: 5.221465587615967
class_loss: 0.5879831910133362, distance_loss: 5.261600971221924
class_loss: 0.6266586780548096, distance_loss: 5.30131196975708
class_loss: 0.6230565905570984, distance_loss: 5.3381266593933105
class_loss: 0.6974954009056091, distance_loss: 5.374569892883301
class_loss: 0.9617828726768494, distance_loss: 5.406975746154785
class_loss: 0.7907885313034058, distance_loss: 5.437503814697266
class_loss: 0.722875714302063, distance_loss: 5.467465877532959
class_loss: 0.6653044819831848, distance_loss: 5.499258518218994
class_loss: 0.5617554187774658, distance_loss: 5.528348445892334
class_loss: 0.7036889791488647, distance_loss: 5.558843612670898
class_loss: 0.506022572517395, distance_loss: 5.5907416343688965
class_loss: 0.5692670941352844, distance_loss: 5.629278182983398
class_loss: 0.33706456422805786, distance_loss: 5.67177677154541
class_loss: 0.39156025648117065, distance_loss: 5.716705799102783
class_loss: 0.35306429862976074, distance_loss: 5.763000965118408
class_loss: 0.17608731985092163, distance_loss: 5.8102850914001465
___PoisonTrain Local_Simple ,  epoch  11, local model 71, internal_epoch   2,  Average loss: 0.0103, Accuracy: 960/1384 (69.3642%), train_poison_data_count: 440
Global model norm: 16.539532092117113.
Norm before scaling: 17.159095847756664. Distance: 5.862491358768951
Total norm for 5 adversaries is: 17.159095847756664. distance: 5.862491358768951
___Test Local_Simple poisoned: True, epoch: 11: Average loss: 0.0655, Accuracy: 8772/8968 (97.8145%)
poison local model 42 index 3
class_loss: 2.349877119064331, distance_loss: 0.0
class_loss: 1.8577362298965454, distance_loss: 0.2074550986289978
class_loss: 1.2086020708084106, distance_loss: 0.5615610480308533
class_loss: 0.9028346538543701, distance_loss: 0.9584099054336548
class_loss: 1.4102065563201904, distance_loss: 1.3310359716415405
class_loss: 1.1734087467193604, distance_loss: 1.6091365814208984
class_loss: 1.0183321237564087, distance_loss: 1.8585214614868164
class_loss: 0.9719399809837341, distance_loss: 2.0872256755828857
___PoisonTrain Local_Simple ,  epoch  11, local model 42, internal_epoch   1,  Average loss: 0.0268, Accuracy: 170/236 (72.0339%), train_poison_data_count: 80
___PoisonTrain Local_Simple ,  epoch  11, local model 42, internal_epoch   2,  Average loss: 0.0194, Accuracy: 137/236 (58.0508%), train_poison_data_count: 80
Global model norm: 16.539532092117113.
Norm before scaling: 16.36239395048951. Distance: 2.296692717708487
Total norm for 5 adversaries is: 16.36239395048951. distance: 2.296692717708487
___Test Local_Simple poisoned: True, epoch: 11: Average loss: 1.2262, Accuracy: 5729/8968 (63.8827%)
class_loss: 3.578488826751709, distance_loss: 0.0
class_loss: 1.7760286331176758, distance_loss: 0.3494974374771118
class_loss: 1.6465920209884644, distance_loss: 0.8455685973167419
class_loss: 1.9029271602630615, distance_loss: 1.2382404804229736
class_loss: 1.5572677850723267, distance_loss: 1.5457653999328613
class_loss: 1.4604359865188599, distance_loss: 1.8432897329330444
class_loss: 1.5495833158493042, distance_loss: 2.120497226715088
class_loss: 1.363229513168335, distance_loss: 2.3677480220794678
class_loss: 1.2645347118377686, distance_loss: 2.5944325923919678
poison local model 45 index 0
___PoisonTrain Local_Simple ,  epoch  11, local model 45, internal_epoch   1,  Average loss: 0.0274, Accuracy: 339/628 (53.9809%), train_poison_data_count: 200
class_loss: 1.1343724727630615, distance_loss: 2.8076863288879395
class_loss: 1.103041648864746, distance_loss: 3.0158886909484863
class_loss: 0.9508664011955261, distance_loss: 3.212510347366333
class_loss: 0.9224571585655212, distance_loss: 3.397196054458618
class_loss: 1.120324969291687, distance_loss: 3.567485809326172
class_loss: 0.8362325429916382, distance_loss: 3.720590829849243
class_loss: 1.0340280532836914, distance_loss: 3.8556265830993652
class_loss: 0.909041166305542, distance_loss: 3.9695332050323486
class_loss: 0.8226180076599121, distance_loss: 4.075804710388184
class_loss: 0.8261398673057556, distance_loss: 4.176437854766846
class_loss: 0.9350726008415222, distance_loss: 4.271108627319336
___PoisonTrain Local_Simple ,  epoch  11, local model 45, internal_epoch   2,  Average loss: 0.0151, Accuracy: 347/628 (55.2548%), train_poison_data_count: 200
Global model norm: 16.539532092117113.
Norm before scaling: 16.732985323951088. Distance: 4.363370206330781
Total norm for 5 adversaries is: 16.732985323951088. distance: 4.363370206330781
___Test Local_Simple poisoned: True, epoch: 11: Average loss: 1.3247, Accuracy: 2673/8968 (29.8060%)
___Train Local_Simple,  epoch  11, local model 37, internal_epoch   1,  Average loss: 0.0012, Accuracy: 842/860 (97.9070%)
___Train Local_Simple,  epoch  11, local model 37, internal_epoch   2,  Average loss: 0.0005, Accuracy: 853/860 (99.1860%)
___Test Local_Simple poisoned: False, epoch: 11: Average loss: 0.2156, Accuracy: 9342/10000 (93.4200%)
___Train Local_Simple,  epoch  11, local model 21, internal_epoch   1,  Average loss: 0.0014, Accuracy: 304/312 (97.4359%)
___Train Local_Simple,  epoch  11, local model 21, internal_epoch   2,  Average loss: 0.0007, Accuracy: 307/312 (98.3974%)
___Test Local_Simple poisoned: False, epoch: 11: Average loss: 0.2631, Accuracy: 9177/10000 (91.7700%)
___Train Local_Simple,  epoch  11, local model 35, internal_epoch   1,  Average loss: 0.0006, Accuracy: 492/499 (98.5972%)
___Train Local_Simple,  epoch  11, local model 35, internal_epoch   2,  Average loss: 0.0003, Accuracy: 498/499 (99.7996%)
___Test Local_Simple poisoned: False, epoch: 11: Average loss: 0.3008, Accuracy: 9117/10000 (91.1700%)
time spent on training: 153.32002997398376
type of model <class 'models.MnistNet.MnistNet'>
selected_attackers: [61, 11, 71, 42, 45]
base_p: [-0.00671691  0.00034668 -0.00212861 ... -0.00301874 -0.01063142
 -0.00044122]
[T_SCORE] attacker_local_idxs is:  [2, 3, 4, 5, 6]
layer1_inf_time: 3.0283203125
[PAIRWISE] pred_attackers_indx:  [2 3 4 5 6]
layer2_inf_t: 190.629638671875
assumed final_attacker_idxs:  [2 3 4 5 6]
final_attacker_idxs is: [2, 3, 4, 5, 6]
g_attacker_idxs: [61 11 71 42 45]
g_normal_idxs: [23 72 37 21 35]
filtered_attacker_idxs: [2, 3, 4, 5, 6]
final_attacker_idxs are: [2, 3, 4, 5, 6]
num_dps: [293, 731, 699, 645, 1384, 236, 628, 860, 312, 499]
epoch_acc: 96.96000000000001
Starting performing KrMLRFL...
Num data points: [293, 731, 699, 645, 1384, 236, 628, 860, 312, 499]
Num selected data points: [293 731 860 312 499]
The chosen ones are users: [0, 1, 7, 8, 9], which are global users: [23, 72, 37, 21, 35]
___Test Local_Simple poisoned: False, epoch: 11: Average loss: 0.1028, Accuracy: 9696/10000 (96.9600%)
___Test Local_Simple poisoned: True, epoch: 11: Average loss: 11.2643, Accuracy: 83/8968 (0.9255%)
Traceback (most recent call last):
  File "dba.py", line 268, in <module>
    poison_epoch_loss, poison_epoch_acc, poison_epoch_corret, poison_epoch_total = trigger_test_byname(helper, agent_name_key, None, epoch)
  File "dba.py", line 54, in trigger_test_byname
    test.Mytest_poison_agent_trigger(helper=helper, model=helper.target_model, agent_name_key=agent_name_key)
  File "/home/ubuntu/dung.nt184244/backdoor-attack/FedGrad-DBA/test.py", line 222, in Mytest_poison_agent_trigger
    data, targets, poison_num = helper.get_poison_batch(batch, adversarial_index=adv_index, evaluation=True)
  File "/home/ubuntu/dung.nt184244/backdoor-attack/FedGrad-DBA/image_helper.py", line 310, in get_poison_batch
    new_images[index] = self.add_pixel_pattern(images[index],adversarial_index)
  File "/home/ubuntu/dung.nt184244/backdoor-attack/FedGrad-DBA/image_helper.py", line 330, in add_pixel_pattern
    image = copy.deepcopy(ori_image)
  File "/home/ubuntu/miniconda3/envs/dungnt/lib/python3.8/copy.py", line 153, in deepcopy
    y = copier(memo)
  File "/home/ubuntu/miniconda3/envs/dungnt/lib/python3.8/site-packages/torch/_tensor.py", line 110, in __deepcopy__
    new_storage = self.storage().__deepcopy__(memo)
  File "/home/ubuntu/miniconda3/envs/dungnt/lib/python3.8/site-packages/torch/storage.py", line 565, in __deepcopy__
    return self._new_wrapped_storage(copy.deepcopy(self._storage, memo))
  File "/home/ubuntu/miniconda3/envs/dungnt/lib/python3.8/copy.py", line 153, in deepcopy
    y = copier(memo)
  File "/home/ubuntu/miniconda3/envs/dungnt/lib/python3.8/site-packages/torch/storage.py", line 88, in __deepcopy__
    new_storage = self.clone()
  File "/home/ubuntu/miniconda3/envs/dungnt/lib/python3.8/site-packages/torch/storage.py", line 102, in clone
    return type(self)(self.nbytes(), device=self.device).copy_(self)
KeyboardInterrupt